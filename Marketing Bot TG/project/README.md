# Telegram бот-ассистент по маркетингу и бизнесу

Telegram бот, который помогает предпринимателям с задачами маркетинга и бизнеса, такими как создание бизнес-планов, формирование ценностных предложений и предоставление маркетинговых советов.

## Функциональность

- **Создание бизнес-планов**: Генерация детальных бизнес-планов на основе информации пользователя
- **Формирование ценностных предложений**: Создание структурированных ценностных предложений для бизнеса
- **Маркетинговые советы**: Профессиональные рекомендации по маркетинговым стратегиям
- **История диалогов**: Бот запоминает контекст разговора для более естественного общения
- **Уровни подписки**: Бесплатный и премиум уровни с различными лимитами сообщений
- **База знаний из PDF**: Загрузка PDF файлов и ответы на основе информации из них с использованием технологии RAG
- **Векторные embeddings**: Семантический поиск по документам с использованием LangChain и OpenAI embeddings

## Структура проекта

```
.
├── bot/
│   ├── config/             # Настройки и конфигурация
│   ├── database/           # Управление базой данных
│   ├── handlers/           # Обработчики сообщений
│   ├── knowledge_base/     # Управление базой знаний из PDF
│   ├── states/             # FSM состояния
│   └── utils/              # Вспомогательные функции
├── knowledge_base_files/   # Директория для хранения PDF файлов
├── vector_storage/         # Хранилище векторных индексов для embeddings
├── temp_uploads/           # Директория для временных файлов
├── load_pdf_example.py     # Скрипт для загрузки PDF через командную строку
├── rag_assistant.py        # Скрипт для демонстрации простого RAG
├── rag_assistant_embeddings.py # Улучшенный RAG с LangChain и embeddings
├── .env                    # Переменные окружения (не в системе контроля версий)
├── .gitignore              # Файл игнорирования для Git
├── main.py                 # Основная точка входа
├── README.md               # Этот файл
└── requirements.txt        # Зависимости
```

## Установка

1. Клонируйте репозиторий
2. Установите зависимости:
   ```
   pip install -r requirements.txt
   ```
3. Создайте файл `.env` и добавьте необходимые переменные окружения:
   ```
   TELEGRAM_TOKEN=ваш_токен_telegram
   OPENAI_API_KEY=ваш_ключ_openai

   # Настройки embeddings (опционально)
   EMBEDDING_MODEL=text-embedding-3-small
   USE_VECTOR_SEARCH=true

   # Опционально, только для доступа к загрузке PDF через Telegram
   # ADMIN_IDS=id1,id2,id3
   ```

> **Важно**: Параметр `ADMIN_IDS` необходим только для ограничения доступа к загрузке PDF через Telegram-бота. Программный интерфейс и скрипты командной строки работают без этого параметра.

## Использование

### Запуск бота

```
python main.py
```

Или сделайте файл исполняемым и запустите:

```
chmod +x main.py
./main.py
```

### Прямая работа с базой знаний (RAG)

В проекте есть несколько скриптов для работы с базой знаний PDF без использования Telegram:

1. **Управление базой знаний через командную строку**:
   ```
   ./load_pdf_example.py load /путь/к/файлу.pdf "Название документа"
   ./load_pdf_example.py list
   ./load_pdf_example.py search "ключевые слова"
   ./load_pdf_example.py delete 1
   ```

2. **Два варианта RAG-ассистента**:

   Стандартный (простой текстовый поиск):
   ```
   ./rag_assistant.py "Как составить маркетинговый план?"
   ```

   Улучшенный (с векторными embeddings):
   ```
   ./rag_assistant_embeddings.py "Как составить маркетинговый план?"
   ```

   Оба скрипта также поддерживают интерактивный режим без параметров:
   ```
   ./rag_assistant_embeddings.py
   ```

Это позволяет использовать систему RAG напрямую, без необходимости запуска бота Telegram.

### Программное использование

Вы можете использовать систему RAG напрямую в своем коде, импортируя необходимые классы:

```python
# Для простого текстового поиска
from bot.knowledge_base import KnowledgeBaseManager
kb_manager = KnowledgeBaseManager()

# Для улучшенного семантического поиска с embeddings
from bot.knowledge_base.vector_kb_manager import VectorKnowledgeBaseManager
kb_manager = VectorKnowledgeBaseManager()

# Загрузка PDF файла
success, doc_id = kb_manager.load_pdf_directly('/путь/к/файлу.pdf', 'Название документа')

# Поиск информации по запросу
content = kb_manager.get_content_for_query('ваш запрос')

# Использование найденной информации с GPT
# ... ваш код для работы с GPT
```

В отличие от интерфейса Telegram-бота, программный интерфейс не требует проверки прав администратора.

## Различия между методами поиска

В проекте реализовано два метода поиска в базе знаний:

1. **Простой текстовый поиск** (класс `KnowledgeBaseManager`):
   - Ищет прямые совпадения слов и фраз в тексте документов
   - Не требует дополнительных моделей, работает только с SQLite
   - Быстрый, но менее точный для семантического понимания
   - Используется в `rag_assistant.py`

2. **Семантический поиск с embeddings** (класс `VectorKnowledgeBaseManager`):
   - Использует векторные embeddings для поиска по смыслу, а не по точным совпадениям
   - Работает на основе LangChain и OpenAI Embeddings API
   - Способен находить семантически похожий контент даже при использовании разных слов
   - Разбивает документы на небольшие чанки для более точного поиска
   - Требует больше ресурсов, но значительно улучшает качество ответов
   - Используется в `rag_assistant_embeddings.py`

Рекомендуется использовать семантический поиск для более точных результатов, если доступен API ключ OpenAI.

## Поддержка Google Colab

Этот бот разработан с учетом работы в Google Colab. При запуске в Colab он может опционально использовать Google Drive для хранения базы данных (см. комментарии в `config/settings.py`).

## Конфигурация

Настройки конфигурации хранятся в `bot/config/settings.py`. Вы можете изменить эти настройки, чтобы настроить:

- Параметры модели GPT
- Модель для embeddings (по умолчанию `text-embedding-3-small`)
- Лимиты подписок
- Настройки базы данных
- Настройки логирования
- Интервалы очистки
- ID администраторов, имеющих доступ к базе знаний (опционально)

## Управление базой знаний

Проект поддерживает работу с PDF файлами через систему RAG (Retrieval-Augmented Generation):

1. **Загрузка документов**:
   - Через Telegram-бота: команда `/kb` (требуются права администратора)
   - Через программный интерфейс: метод `load_pdf_directly` (не требуются права администратора)
   - Через командную строку: скрипт `load_pdf_example.py` (не требуются права администратора)

2. **Обработка документов**:
   - Извлечение текста из PDF файлов с помощью PyPDF2
   - Индексирование содержимого для быстрого поиска
   - Преобразование текста в векторные embeddings (при использовании улучшенного поиска)
   - Хранение в структурированной базе данных SQLite и векторном индексе FAISS

3. **Поиск информации**:
   - При получении вопроса система ищет релевантную информацию в загруженных документах
   - В режиме простого поиска: поиск по ключевым словам и фразам
   - В режиме улучшенного поиска: семантический поиск по векторным embeddings
   - Наиболее подходящие фрагменты извлекаются и объединяются

4. **Генерация ответов**:
   - Найденная информация добавляется к контексту запроса к GPT
   - Модель генерирует ответ, основываясь как на собственных знаниях, так и на информации из документов
   - Это обеспечивает более точные и актуальные ответы

Для прямого использования системы RAG без Telegram, используйте скрипты `rag_assistant.py` или `rag_assistant_embeddings.py`.

## Разработка

Проект разделен на модули для облегчения поддержки и расширения:

- `config`: Содержит все настройки и промпты для GPT
- `database`: Управление базой данных SQLite
- `handlers`: Обработчики сообщений Telegram
- `states`: Состояния для машины конечных состояний
- `utils`: Вспомогательные функции для обработки текста и взаимодействия с OpenAI
- `knowledge_base`: Управление базой знаний из PDF файлов, включая векторные методы

### Добавление новых функций

Для добавления новой функциональности:

1. Добавьте необходимые промпты в `bot/config/prompts.py`
2. Создайте новые состояния в `bot/states/states.py`, если необходимо
3. Создайте новый обработчик в `bot/handlers/`
4. Зарегистрируйте обработчик в `bot/handlers/__init__.py`
